<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
      integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="stylesheet" href="/othercssfiles/orders.css" />
  </head>
  <body>
    <header>
      <div class="logo">
        <a href="index.html"
          ><img
            src="images/kitab_hub-removebg-preview.png"
            alt="Bookstore Logo"
            height="60"
        /></a>
      </div>
      <div class="menu-toggle" id="menuToggle">
        <i class="fa-solid fa-bars"></i>
      </div>
      <nav>
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="cart.html">Cart</a></li>
          <li><a href="orders.html" class="active">My Orders</a></li>
        </ul>
      </nav>
    </header>

    <h2 style="padding: 20px">My Orders</h2>
    <div id="orders-container" style="padding: 20px"></div>

    <script type="module">
      import { auth, db } from "./firebase.js";
      import {
        collection,
        query,
        where,
        getDocs,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const ordersContainer = document.getElementById("orders-container");

      async function loadOrders() {
        const user = auth.currentUser;

        if (!user) {
          ordersContainer.innerHTML =
            "<p>Please log in to view your orders.</p>";
          return;
        }

        try {
          const q = query(
            collection(db, "orders"),
            where("userId", "==", user.uid),
            orderBy("createdAt", "desc")
          );

          const snapshot = await getDocs(q);

          if (snapshot.empty) {
            ordersContainer.innerHTML = "<p>You have no orders yet.</p>";
            return;
          }

          snapshot.forEach((doc) => {
            const order = doc.data();
            const date = order.createdAt?.toDate
              ? order.createdAt.toDate()
              : new Date();
            let itemsHtml = "";
            order.items.forEach((item) => {
              itemsHtml += `
              <div style="border:1px solid #ccc; padding:10px; margin-bottom:5px; display:flex; gap:10px; align-items:center;">
                <img src="${item.image}" width="60" 
                     onerror="this.onerror=null;this.src='images/placeholder.png';">
                <div>
                  <strong>${item.name}</strong> - ₦${item.price} x ${
                item.qty
              } = ₦${item.price * item.qty}
                </div>
              </div>
            `;
            });

            ordersContainer.innerHTML += `
            <div style="border:2px solid #333; padding:15px; margin-bottom:20px; border-radius:6px;">
              <h4>Order ID: ${doc.id}</h4>
              <p>Placed on: ${date.toLocaleString()}</p>
              ${itemsHtml}
              <h3>Total: ₦${order.total}</h3>
            </div>
          `;
          });
        } catch (error) {
          console.error("Error loading orders:", error);
          ordersContainer.innerHTML =
            "<p>Failed to load orders. Check console for details.</p>";
        }
      }

      auth.onAuthStateChanged(() => {
        loadOrders();
      });
      // Mobile menu toggle
      const menuToggle = document.getElementById("menuToggle");
      const nav = document.querySelector("header nav");
      menuToggle.addEventListener("click", () => {
        nav.classList.toggle("show");
      });
    </script>
  </body>
</html>
